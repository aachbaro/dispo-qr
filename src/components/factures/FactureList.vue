<!-- src/components/factures/FactureList.vue -->
<!-- -------------------------------------------------------------
 Liste des factures (FactureList)
 ---------------------------------------------------------------
 📌 Description :
 - Affiche une liste de FactureCard
 - Mode entreprise : édition, suppression, génération lien
 - Mode client (readonly) : lecture seule, téléchargement PDF, lien paiement

 🔒 Règles d’accès :
 - Entreprise/admin : accès complet
 - Client (readonly) : lecture seule
 ------------------------------------------------------------- -->

<template>
  <div class="space-y-4 mt-8">
    <!-- Titre -->
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-bold text-gray-800">📑 Factures</h2>
    </div>

    <!-- Loading -->
    <div v-if="loading" class="text-gray-500 italic">
      Chargement des factures...
    </div>

    <!-- Vide -->
    <div v-else-if="factures.length === 0" class="text-gray-500 italic">
      Aucune facture pour le moment.
    </div>

    <!-- Liste -->
    <div v-else class="grid gap-3">
      <FactureCard
        v-for="f in factures"
        :key="f.id"
        :facture="f"
        :ref-entreprise="refEntreprise"
        :entreprise="entreprise"
        :readonly="readonly"
        @edit="onEdit"
        @deleted="onDeleted"
        @updated="onUpdated"
      />
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, watch } from "vue";
import { useFactures } from "../../composables/useFactures";
import FactureCard from "./FactureCard.vue";

const props = defineProps<{
  refEntreprise?: string | number | null;
  entreprise?: any; // ⚠️ doit contenir infos de l’entreprise (iban, bic…)
  readonly?: boolean; // 👈 nouveau mode lecture seule
}>();

const emit = defineEmits(["edit", "deleted", "updated"]);

const { factures, loading, fetchFactures } = useFactures();

// Charger au montage
onMounted(() => {
  if (!props.readonly && props.refEntreprise) {
    // ⚡ Mode entreprise → filtrer par refEntreprise
    fetchFactures(props.refEntreprise);
  } else if (props.readonly) {
    // ⚡ Mode client → backend filtre automatiquement
    fetchFactures();
  }
});

// Recharger si refEntreprise change (mode entreprise uniquement)
watch(
  () => props.refEntreprise,
  (newRef) => {
    if (!props.readonly && newRef) fetchFactures(newRef);
  }
);

function onEdit(facture: any) {
  emit("edit", facture);
}

function onDeleted(id: number) {
  emit("deleted", id);
}

function onUpdated(facture: any) {
  emit("updated", facture);
}
</script>
